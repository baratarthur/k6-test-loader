apiVersion: v1
kind: ConfigMap
metadata:
  name: k6-test-script
data:
  test.js: |
    import http from 'k6/http';
    import { check, sleep } from 'k6';
    import { randomIntBetween } from 'https://jslib.k6.io/k6-utils/1.2.0/index.js';
    import { Trend, Counter } from 'k6/metrics';

    // Métricas personalizadas
    const latenciaMatmul = new Trend('custom_latency_matmul');
    const rpsCounter = new Counter('custom_rps_matmul');

    export const options = {
        stages: [
            { duration: '1s', target: 2 },
            { duration: '10s', target: 30 },
            { duration: '10s', target: 300 },
            { duration: '10s', target: 500 },
            { duration: '10s', target: 800 },
            { duration: '10s', target: 1200 },
            { duration: '10s', target: 1500 },
            { duration: '10s', target: 1800 },
            { duration: '10s', target: 2000 },
        ],
    };

    function generateRandomMatrix(rows, cols) {
        let matrix = [];
        for (let i = 0; i < rows; i++) {
            let row = [];
            for (let j = 0; j < cols; j++) {
                row.push(randomIntBetween(1, 100));
            }
            matrix.push(row);
        }
        return matrix;
    }

    function generateIdentityMatrix(size) {
        let matrix = [];
        for (let i = 0; i < size; i++) {
            let row = [];
            for (let j = 0; j < size; j++) {
                row.push(i === j ? 1 : 0);
            }
            matrix.push(row);
        }
        return matrix;
    }

    const identityMatrix = generateIdentityMatrix(20);

    export default function () {
        const apiUrl = 'http://192.168.5.20:5050/';

        const payload = JSON.stringify({
            A: JSON.stringify(generateRandomMatrix(20, 20)),
            B: JSON.stringify(identityMatrix)
        });

        const params = {
            headers: { 'Content-Type': 'application/json' },
            tags: { name: 'Matmul' },
            timeout: '5s',
        };

        const resMatmul = http.post(apiUrl, payload, params);

        // --- Coleta de Métricas ---
        // Registra a latência (duration) da requisição
        latenciaMatmul.add(resMatmul.timings.duration);
        
        // Incrementa o contador de requisições para cálculo de RPS
        rpsCounter.add(1);

        check(resMatmul, {
            'status é 200': (r) => r.status === 200,
            'tempo de resposta < 500ms': (r) => r.timings.duration < 500,
        });

        sleep(1);
    }
---
apiVersion: batch/v1
kind: Job
metadata:
  name: k6-job
  labels:
    app: k6-load-tester
spec:
  template:             # Adicionado
    metadata:
      labels:
        app: k6-load-tester
    spec:               # Adicionado
      containers:
      - name: k6
        image: grafana/k6:latest
        command: ["sh", "-c", "k6 run /scripts/test.js --out csv=/results/data.csv && echo 'Teste finalizado. Dormindo...' && sleep 600"]
        volumeMounts:
        - name: script-volume
          mountPath: /scripts
        - name: results-volume
          mountPath: /results
      restartPolicy: Never
      volumes:
      - name: script-volume
        configMap:
          name: k6-test-script
      - name: results-volume
        emptyDir: {}